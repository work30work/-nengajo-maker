<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸŒ¸ ä½œç”¨å¹´è³€çŠ¶è£½ä½œæ‰€ ğŸŒ¸</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&family=Kaisei+Decol:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&family=Ma+Shan+Zheng&family=Yuji+Syuku&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #d65a75;
      --secondary: #ffc6c7;
      --bg-color: #fdfcf8;
      --text-color: #4a4a4a;
      --card-shadow: 0 8px 20px rgba(0,0,0,0.15); /* é™°å½±åŠ æ·±ï¼Œæ›´æœ‰å¡ç‰‡æ„Ÿ */
    }

    body { 
      background-color: var(--bg-color); 
      color: var(--text-color);
      font-family: "Zen Maru Gothic", "Noto Sans TC", sans-serif; 
      margin: 0; padding: 20px 10px;
      text-align: center;
    }
    
    h2 { 
      margin: 0 0 20px 0; color: var(--primary); 
      font-weight: 700; letter-spacing: 2px; 
      display: inline-block;
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 10px;
    }

    .app-container {
      display: flex; gap: 30px;
      max-width: 1200px; width: 100%;
      margin: 0 auto;
      align-items: flex-start; justify-content: center;
      flex-wrap: wrap; 
    }

    /* å·¦å´ï¼šç•«å¸ƒå€ */
    .canvas-section {
      flex: 0 0 auto;
      display: flex; flex-direction: column; gap: 15px; align-items: center;
      width: 100%; max-width: 520px;
    }
    
    /* ç•«å¸ƒå®¹å™¨ï¼šæ¨¡æ“¬çœŸå¯¦å¡ç‰‡è³ªæ„Ÿ */
    .canvas-wrapper { 
      box-shadow: var(--card-shadow); 
      border: 1px solid #ddd; /* ç´°é‚Šæ¡† */
      background-color: #fff;
      /* æ‹¿æ‰æ ¼ç·šï¼Œè®“å®ƒçœ‹èµ·ä¾†æ›´åƒä¸€å¼µç™½ç´™å¡ç‰‡ */
      max-width: 100%; 
      overflow: hidden;
      transition: transform 0.3s;
    }

    /* å³å´ï¼šå·¥å…·é¢æ¿ */
    .tools-section {
      flex: 1; min-width: 300px; max-width: 450px;
      display: flex; flex-direction: column; gap: 20px;
      text-align: left;
    }

    .tool-card {
      background: white; padding: 20px; border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    
    .card-title {
      font-size: 15px; font-weight: 700; color: #888; margin: 0 0 12px 0;
      border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }

    button { 
      padding: 10px 12px; cursor: pointer;
      border: 1px solid #eee; background: white; 
      border-radius: 8px; font-size: 14px; color: #555;
      transition: 0.2s; font-family: inherit; font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      white-space: nowrap; 
    }
    button:active { transform: translateY(0); box-shadow: none; }
    
    button.active { 
      background: var(--primary); color: white; border-color: var(--primary); 
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .full-width { width: 100%; }
    .full-width button { flex: 1; }

    .tool-row {
      display: flex; gap: 10px; margin-bottom: 10px; 
      flex-wrap: wrap; align-items: center;
    }

    /* ç´ æåˆ†é¡ Tabs (ç§»é™¤å°ç« ) */
    .category-tabs { display: flex; gap: 5px; margin-bottom: 10px; background: #f5f5f5; padding: 4px; border-radius: 8px; }
    .tab-btn {
      flex: 1; border: none; background: transparent; padding: 8px; font-size: 13px;
      border-radius: 6px; box-shadow: none; color: #666;
    }
    .tab-btn.active-tab {
      background: white; color: var(--primary); font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .sticker-grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
      gap: 8px; max-height: 250px; overflow-y: auto; padding: 5px;
      min-height: 100px;
    }
    .sticker-grid img { 
      width: 100%; aspect-ratio: 1; object-fit: contain; 
      border: 1px solid #f0f0f0; border-radius: 8px; 
      background: #fff; cursor: pointer;
    }

    .switch-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; }
    input[type="checkbox"] { accent-color: var(--primary); width: 16px; height: 16px; }

    .color-picker-wrapper {
      position: relative; overflow: hidden; width: 36px; height: 36px; border-radius: 50%;
      border: 2px solid #fff; box-shadow: 0 0 0 1px #ddd; cursor: pointer; flex-shrink: 0;
    }
    input[type="color"] {
      position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      padding: 0; border: none; cursor: pointer;
    }
    
    select {
      padding: 8px; border: 1px solid #ccc; border-radius: 6px; background: white;
      font-size: 14px; min-width: 120px;
    }

    #status-msg { 
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(74, 74, 74, 0.95); color: white; 
      padding: 10px 24px; border-radius: 30px; 
      font-size: 13px; letter-spacing: 1px;
      opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000;
    }

    @media (max-width: 600px) {
      h2 { font-size: 18px; }
      .app-container { gap: 20px; }
      .tools-section { width: 100%; min-width: auto; }
      .btn-group button { padding: 10px; }
      #text-input { min-width: 150px; } 
    }
  </style>
</head>
<body>

  <h2>ğŸŒ¸ ä½œç”¨å¹´è³€çŠ¶è£½ä½œæ‰€ ğŸŒ¸</h2>

  <div class="app-container">
    
    <div class="canvas-section">
      <div class="canvas-wrapper">
        <canvas id="c"></canvas>
      </div>
      
      <div class="btn-group" style="margin-top: 10px; width: 100%;">
        <button onclick="undo()" id="btn-undo">â†©ï¸ å¾©åŸ</button>
        <button onclick="redo()" id="btn-redo">â†ªï¸ é‡åš</button>
        <button onclick="clearCanvas()" style="flex:1">ğŸ—‘ï¸ é‡ä¾†</button>
        <button onclick="downloadImage()" style="flex:2; background: #4CAF50; color: white; border: none;">ğŸ’¾ ä¿å­˜å¡ç‰‡</button>
      </div>
    </div>

    <div class="tools-section">

      <div class="tool-card">
        <div class="card-title">
          <span>ğŸ“¦ é›²ç«¯ç´ æåº«</span>
          <label class="switch-label">
            <input type="checkbox" id="bg-mode-toggle"> 
            <span style="color:var(--primary); font-weight:bold;">è¨­ç‚ºèƒŒæ™¯</span>
          </label>
        </div>

        <div class="category-tabs">
          <button class="tab-btn active-tab" onclick="switchCategory('stickers', this)">ğŸ¶ è²¼åœ–</button>
          <button class="tab-btn" onclick="switchCategory('backgrounds', this)">ğŸ–¼ï¸ èƒŒæ™¯/åº•åœ–</button>
        </div>

        <div id="sticker-list" class="sticker-grid">
          <p style="font-size:12px; color:#999; padding:10px;">è®€å–ä¸­...</p>
        </div>
        
        <div style="margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">
           <label style="display:flex; align-items:center; gap:5px; justify-content:center; cursor:pointer; color:#888; font-size:12px;">
             ğŸ“‚ ä¸Šå‚³è‡ªå·±çš„åœ–ç‰‡
             <input type="file" style="display:none" accept="image/*" onchange="handleUniversalUpload(this)">
           </label>
        </div>
      </div>

      <div class="tool-card">
        <div class="card-title">æ“ä½œæ¨¡å¼</div>
        <div class="btn-group full-width">
          <button onclick="setMode('select')" id="btn-select" class="active">âœ‹ èª¿æ•´æ¨¡å¼</button>
          <button onclick="setMode('draw')" id="btn-draw">ğŸ–Œï¸ å¡—é´‰æ¨¡å¼</button>
        </div>
        
        <div id="brush-controls" style="margin-top: 15px; display: none; background: #f9f9f9; padding: 10px; border-radius: 8px;">
          <div class="tool-row">
            <div class="color-picker-wrapper" title="ç­†åˆ·é¡è‰²">
              <input type="color" id="brush-color" value="#000000" onchange="updateBrush()">
            </div>
            <select id="brush-type" onchange="updateBrush()" style="flex:1;">
              <option value="calligraphy">âœ’ï¸ æ¯›ç­† (Calligraphy)</option>
              <option value="pencil">âœï¸ é‰›ç­† (Pencil)</option>
              <option value="marker">ğŸ–ï¸ è¢å…‰ç­† (Marker)</option>
              <option value="spray">ğŸ’¨ å™´æ§ (Spray)</option>
              <option value="eraser">â¬œ æ©¡çš®æ“¦ (Eraser)</option>
            </select>
          </div>
          <div class="tool-row">
            <span style="font-size:12px;">ç²—ç´°</span>
            <input type="range" id="brush-width" min="1" max="50" value="8" onchange="updateBrush()" style="flex:1;">
          </div>
        </div>
      </div>

      <div class="tool-card">
        <div class="card-title">æ–‡å­—å·¥å…·</div>
        
        <div class="tool-row">
          <input type="text" id="text-input" placeholder="è¼¸å…¥è³€è©..." value="æ–°å¹´å¿«æ¨‚" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
          <div class="color-picker-wrapper" title="æ–‡å­—é¡è‰²">
            <input type="color" id="text-color" value="#d65a75">
          </div>
        </div>

        <div class="tool-row">
          <select id="font-select" style="flex:2;">
            <option value="Ma Shan Zheng">æ›¸æ³•æ‰‹å¯«é«”</option>
            <option value="Hachi Maru Pop">å¯æ„›æ³¢æ³¢é«” (æ–°!)</option>
            <option value="Zen Maru Gothic">æ—¥ç³»åœ“é«”</option>
            <option value="Kaisei Decol">å„ªé›…è¥¯ç·šé«” (æ–°!)</option>
            <option value="Yuji Syuku">æ—¥å¼è¡Œæ›¸</option>
            <option value="Noto Serif TC">æ¨™æº–æ˜é«”</option>
            <option value="Noto Sans TC">æ¨™æº–é»‘é«”</option>
          </select>
          <button onclick="toggleVertical()" id="btn-vertical" style="flex:1;">â¡ï¸ æ©«æ›¸</button>
        </div>
        
        <button onclick="addText()" class="full-width" style="background:#f0f0f0;">â• åŠ å…¥æ–‡å­—</button>
      </div>

      <div class="tool-card">
        <div class="card-title">åœ–å±¤é †åº</div>
        <div class="btn-group full-width">
          <button onclick="moveLayer('front')">â¬†ï¸ ç½®é ‚</button>
          <button onclick="moveLayer('up')">â†‘ ä¸Šç§»</button>
          <button onclick="moveLayer('down')">â†“ ä¸‹ç§»</button>
          <button onclick="moveLayer('back')">â¬‡ï¸ ç½®åº•</button>
        </div>
      </div>

    </div>
  </div>

  <div id="status-msg">æ“ä½œæˆåŠŸ</div>

   <script>
    // âš ï¸âš ï¸âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Supabase è³‡æ–™ âš ï¸âš ï¸âš ï¸
    const SUPABASE_URL = 'https://kyjppevleohxkrxvghve.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_ICm0LIiw6DHBz-s7SHUYuQ_kDqSlITB';


    // --- åˆå§‹åŒ– (é»ƒé‡‘æ¯”ä¾‹ä¿®å¾© 100:148) ---
    // 1. å…ˆæŠ“è¢å¹•å¯¬åº¦ï¼Œè¨­å®šæœ€å¤§å¯¬åº¦ (ä¾‹å¦‚æ¡Œæ©Ÿ 500ï¼Œæ‰‹æ©Ÿå‰‡æ»¿ç‰ˆæ‰£é‚Šè·)
    const screenWidth = window.innerWidth;
    const maxCanvasWidth = 500;
    const canvasWidth = Math.min(maxCanvasWidth, screenWidth - 30);
    
    // 2. æ ¹æ“šæ—¥æœ¬è³€å¹´å¡æ¯”ä¾‹ (148/100 = 1.48) è¨ˆç®—é«˜åº¦
    // é€™æ¨£ä¸ç®¡å¯¬åº¦å¤šå°‘ï¼Œé•·å¯¬æ¯”æ°¸é æ˜¯æ­£ç¢ºçš„é•·æ–¹å½¢
    const canvasHeight = canvasWidth * 1.48;

    const canvas = new fabric.Canvas('c', {
      width: canvasWidth,
      height: canvasHeight,
      backgroundColor: '#ffffff',
      isDrawingMode: false,
      preserveObjectStacking: true 
    });

    let isVertical = false;
    let history = [];
    let historyRedo = [];
    let isHistoryProcessing = false;
    let currentCategory = 'stickers';

    // --- æ­·å²ç´€éŒ„ (Undo/Redo) ---
    function saveState() {
      if (isHistoryProcessing) return;
      if (history.length > 30) history.shift();
      history.push(JSON.stringify(canvas.toDatalessJSON(['isBackground'])));
      historyRedo = [];
      updateHistoryButtons();
    }
    
    function restoreLocks() {
      canvas.getObjects().forEach(obj => {
        if (obj.isBackground) {
          obj.set({
            selectable: false, evented: false, hasControls: false,
            hasBorders: false, lockMovementX: true, lockMovementY: true
          });
          canvas.sendToBack(obj);
        }
      });
      canvas.requestRenderAll();
    }

    canvas.on('object:added', (e) => { if(!isHistoryProcessing) saveState(); });
    canvas.on('object:modified', saveState);
    canvas.on('object:removed', saveState);
    canvas.on('path:created', saveState);

    function undo() {
      if (history.length === 0) return;
      isHistoryProcessing = true;
      historyRedo.push(JSON.stringify(canvas.toDatalessJSON(['isBackground'])));
      const content = history.pop();
      canvas.loadFromJSON(content, () => {
        restoreLocks();
        isHistoryProcessing = false;
        updateHistoryButtons();
        showStatus('å·²å¾©åŸ');
      });
    }

    function redo() {
      if (historyRedo.length === 0) return;
      isHistoryProcessing = true;
      history.push(JSON.stringify(canvas.toDatalessJSON(['isBackground'])));
      const content = historyRedo.pop();
      canvas.loadFromJSON(content, () => {
        restoreLocks();
        isHistoryProcessing = false;
        updateHistoryButtons();
        showStatus('å·²é‡åš');
      });
    }

    function updateHistoryButtons() {
      document.getElementById('btn-undo').disabled = (history.length === 0);
      document.getElementById('btn-redo').disabled = (historyRedo.length === 0);
    }
    saveState();


    // --- é›²ç«¯ç´ æåˆ†é¡ ---
    async function switchCategory(category, btn) {
      currentCategory = category;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
      btn.classList.add('active-tab');

      const bgToggle = document.getElementById('bg-mode-toggle');
      if (category === 'backgrounds') {
        bgToggle.checked = true;
      } else {
        bgToggle.checked = false;
      }
      loadCloudImages(category);
    }

    async function loadCloudImages(folder) {
      const listDiv = document.getElementById('sticker-list');
      if (SUPABASE_URL.includes('xxxx')) {
        listDiv.innerHTML = '<p style="color:#d65a75; font-size:12px;">âš ï¸ è«‹å¡« Key</p>';
        return;
      }
      
      listDiv.innerHTML = '<p style="font-size:12px; color:#999; padding:5px;">è®€å–ä¸­...</p>';

      try {
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { data, error } = await supabase.storage.from('assets').list(folder);
        
        if (error) throw error;
        
        listDiv.innerHTML = '';
        if (data && data.length > 0) {
          const items = data.filter(i => i.name !== '.emptyFolderPlaceholder');
          if (items.length === 0) {
             listDiv.innerHTML = `<p style="font-size:12px; padding:10px;">è³‡æ–™å¤¾ ${folder} æ˜¯ç©ºçš„</p>`;
             return;
          }

          items.forEach(item => {
            const url = supabase.storage.from('assets').getPublicUrl(folder + '/' + item.name).data.publicUrl;
            
            const img = document.createElement('img');
            img.src = url;
            img.onclick = () => {
              fabric.Image.fromURL(url, (oImg) => {
                processImage(oImg);
              }, { crossOrigin: 'anonymous' });
            };
            listDiv.appendChild(img);
          });
        } else {
          listDiv.innerHTML = `<p style="font-size:12px; padding:10px;">è³‡æ–™å¤¾ç‚ºç©º</p>`;
        }
      } catch (err) {
        console.error(err);
        listDiv.innerHTML = '<p style="color:red; font-size:12px;">è®€å–å¤±æ•—</p>';
      }
    }


    // --- æ ¸å¿ƒåŠŸèƒ½ ---

    function setMode(mode) {
      document.getElementById('btn-select').className = (mode === 'select' ? 'active' : '');
      document.getElementById('btn-draw').className = (mode === 'draw' ? 'active' : '');
      document.getElementById('brush-controls').style.display = (mode === 'draw') ? 'block' : 'none';

      if (mode === 'select') {
        canvas.isDrawingMode = false;
      } else {
        canvas.isDrawingMode = true;
        // åˆ‡æ›åˆ°ç•«ç•«æ¨¡å¼æ™‚ï¼Œè‡ªå‹•è¨­ç‚ºæ¯›ç­†é è¨­
        updateBrush(); 
      }
    }

    function updateBrush() {
      if (!canvas.isDrawingMode) return;
      const type = document.getElementById('brush-type').value;
      const color = document.getElementById('brush-color').value;
      const width = parseInt(document.getElementById('brush-width').value, 10);

      // å…ˆé‡ç½®ç­†åˆ·
      let brush;
      
      if (type === 'spray') {
        brush = new fabric.SprayBrush(canvas);
        brush.width = width * 2;
      } else if (type === 'calligraphy') {
        // æ¯›ç­†æ¨¡æ“¬ï¼šç”¨é‰›ç­†åˆ·ä½†é è¨­æ¯”è¼ƒç²—
        brush = new fabric.PencilBrush(canvas);
        brush.width = width; 
        // é€™è£¡å¯ä»¥å¾®èª¿ï¼Œä½† Fabric åŸç”Ÿæ”¯æ´æœ‰é™ï¼Œå…ˆç”¨å¯¬åº¦å€åˆ†
      } else {
        brush = new fabric.PencilBrush(canvas);
        brush.width = width;
      }

      // é¡è‰²èˆ‡ç‰¹æ®Šæ•ˆæœ
      if (type === 'eraser') {
        brush = new fabric.PencilBrush(canvas);
        brush.color = "#ffffff";
        brush.width = width * 3;
      } else if (type === 'marker') {
        const c = new fabric.Color(color);
        c.setAlpha(0.3);
        brush.color = c.toRgba();
        brush.width = width * 3;
      } else {
        brush.color = color;
      }

      canvas.freeDrawingBrush = brush;
    }

    function processImage(img) {
      const isBgMode = document.getElementById('bg-mode-toggle').checked;

      if (isBgMode) {
        // ç¢ºä¿èƒŒæ™¯è‡³å°‘å¡«æ»¿ç•«å¸ƒ
        const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
        img.set({
          left: canvas.width / 2, top: canvas.height / 2,
          originX: 'center', originY: 'center',
          scaleX: scale, scaleY: scale,
          selectable: false, evented: false, hasControls: false, hasBorders: false,
          lockMovementX: true, lockMovementY: true,
          isBackground: true 
        });
        canvas.add(img);
        canvas.sendToBack(img); 
        canvas.discardActiveObject();
        canvas.requestRenderAll();
        showStatus('ğŸ–¼ï¸ èƒŒæ™¯å·²è¨­å®š');
      } else {
        // è²¼åœ–ç¸®æ”¾
        const targetWidth = canvas.width * 0.4; 
        img.scaleToWidth(targetWidth);
        img.set({left: canvas.width/2 - targetWidth/2, top: 150, isBackground: false});
        canvas.add(img);
        canvas.setActiveObject(img);
        showStatus('âœ… åœ–ç‰‡å·²åŠ å…¥');
      }
      setMode('select');
    }

    function handleUniversalUpload(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(f) {
        fabric.Image.fromURL(f.target.result, function(img) {
          processImage(img);
        });
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    function addText() {
      const textVal = document.getElementById('text-input').value;
      const fontVal = document.getElementById('font-select').value;
      const colorVal = document.getElementById('text-color').value;
      const finalVal = isVertical ? textVal.split('').join('\n') : textVal;

      const text = new fabric.IText(finalVal, {
        left: 50, top: 100, fontSize: 40,
        fontFamily: fontVal, fill: colorVal,
        textAlign: isVertical ? 'center' : 'left',
        lineHeight: isVertical ? 0.85 : 1.2
      });

      canvas.add(text);
      canvas.setActiveObject(text);
      setMode('select');
    }

    function toggleVertical() {
      isVertical = !isVertical;
      const btn = document.getElementById('btn-vertical');
      btn.textContent = isVertical ? 'â¬‡ï¸ ç›´æ›¸' : 'â¡ï¸ æ©«æ›¸';
    }

    function moveLayer(dir) {
      const active = canvas.getActiveObject();
      if (!active) return showStatus('è«‹å…ˆé¸å–ç‰©ä»¶');
      if (active.selectable === false || active.isBackground) return showStatus('èƒŒæ™¯ä¸èƒ½ç§»å‹•');

      if (dir === 'front') active.bringToFront();
      if (dir === 'back') active.sendToBack();
      if (dir === 'up') active.bringForward();
      if (dir === 'down') active.sendBackwards();
      
      canvas.discardActiveObject();
      canvas.requestRenderAll();
      saveState();
    }

    function showStatus(msg) {
      const el = document.getElementById('status-msg');
      el.textContent = msg;
      el.style.opacity = 1;
      setTimeout(() => el.style.opacity = 0, 2000);
    }
    function clearCanvas() {
      if(confirm('ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ')) { 
        canvas.clear(); canvas.setBackgroundColor('#ffffff'); history = []; saveState();
      }
    }
    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'my-nengajo.png';
      link.href = canvas.toDataURL({format:'png', quality:1});
      link.click();
    }

    // å•Ÿå‹•é è¨­åˆ†é¡
    loadCloudImages('stickers');
  </script>
</body>
</html>
