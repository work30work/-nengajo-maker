<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ä½œç”¨å¹´è³€çŠ¶è£½ä½œæ‰€ (é™¤éŒ¯ç‰ˆ)</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&family=Ma+Shan+Zheng&family=Yuji+Syuku&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>

  <style>
    :root {
      --primary: #d65a75;
      --secondary: #ffc6c7;
      --bg-color: #fdfcf8;
      --text-color: #4a4a4a;
    }

    body { 
      background-color: var(--bg-color); 
      color: var(--text-color);
      font-family: "Zen Maru Gothic", "Noto Sans TC", sans-serif; 
      margin: 0; padding: 10px;
      text-align: center;
      /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ•´å¹²æ“¾ç•«ç•« */
      overscroll-behavior: none; 
    }
    
    h2 { 
      margin: 10px 0; color: var(--primary); 
      font-weight: 700; font-size: 18px;
    }

    .app-container {
      display: flex; flex-direction: column; align-items: center; gap: 15px;
      width: 100%; max-width: 600px; margin: 0 auto;
    }

    /* ç•«å¸ƒå®¹å™¨ï¼šå¼·åˆ¶çµ¦ä¸€å€‹æœ€å°é«˜åº¦ï¼Œé¿å…ç©ºç™½ */
    .canvas-section { width: 100%; }
    
    .canvas-wrapper { 
      border: 5px solid white; border-radius: 4px;
      background-color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin: 0 auto;
      /* é—œéµï¼šå¦‚æœ canvas æ²’å‡ºä¾†ï¼Œè‡³å°‘é¡¯ç¤ºé€™å¡Šç°è‰²å€åŸŸ */
      min-height: 300px; 
      background-image: radial-gradient(#ddd 1px, transparent 1px);
      background-size: 20px 20px;
      overflow: hidden;
      position: relative;
    }

    /* è¼‰å…¥ä¸­æç¤º */
    #loading-text {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: #999; pointer-events: none;
    }

    /* å·¥å…·é¢æ¿ */
    .tools-section { width: 100%; text-align: left; }

    .tool-card {
      background: white; padding: 15px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 15px;
    }
    
    .card-title {
      font-size: 14px; font-weight: 700; color: #888; margin-bottom: 10px;
      border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;
      display: flex; justify-content: space-between; align-items: center;
    }

    /* æŒ‰éˆ•å¤§ä¸€é»ï¼Œé©åˆæ‰‹æŒ‡ */
    button { 
      padding: 10px 12px; cursor: pointer; 
      border: 1px solid #eee; background: white; 
      border-radius: 8px; font-size: 14px; color: #555;
      font-family: inherit; margin: 2px;
    }
    button.active { background: var(--primary); color: white; border-color: var(--primary); }

    .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
    .full-width { display: flex; width: 100%; gap: 5px; }
    .full-width button { flex: 1; }

    /* è²¼åœ–åº« */
    .category-tabs { display: flex; gap: 5px; margin-bottom: 10px; background: #f5f5f5; padding: 4px; border-radius: 8px; }
    .tab-btn { flex: 1; border: none; background: transparent; }
    .tab-btn.active-tab { background: white; color: var(--primary); font-weight: bold; }

    .sticker-grid { 
      display: grid; grid-template-columns: repeat(4, 1fr); 
      gap: 8px; max-height: 200px; overflow-y: auto;
    }
    .sticker-grid img { width: 100%; aspect-ratio: 1; object-fit: contain; border: 1px solid #eee; background: #fff; }

    /* å…¶ä»–å…ƒä»¶ */
    .switch-label { display: flex; align-items: center; gap: 5px; font-size: 13px; }
    #status-msg { 
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: white; padding: 8px 20px; 
      border-radius: 20px; font-size: 12px; opacity: 0; pointer-events: none; z-index: 9999;
    }
  </style>
</head>
<body>

  <script>
    // å•Ÿå‹•æ‰‹æ©Ÿé™¤éŒ¯æŒ‰éˆ•
    var vConsole = new VConsole();
    console.log("vConsole å•Ÿå‹•æˆåŠŸï¼ç­‰å¾…ç•«å¸ƒè¼‰å…¥...");
  </script>

  <h2>ğŸŒ¸ ä½œç”¨å¹´è³€çŠ¶è£½ä½œæ‰€ ğŸŒ¸</h2>

  <div class="app-container">
    
    <div class="canvas-section">
      <div class="canvas-wrapper" id="canvas-container">
        <span id="loading-text">ç•«å¸ƒè¼‰å…¥ä¸­...</span>
        <canvas id="c"></canvas>
      </div>
      
      <div class="btn-group" style="margin-top: 10px;">
        <button onclick="undo()">â†©ï¸</button>
        <button onclick="redo()">â†ªï¸</button>
        <button onclick="clearCanvas()">ğŸ—‘ï¸ é‡ä¾†</button>
        <button onclick="downloadImage()" style="background: #4CAF50; color: white;">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>

    <div class="tools-section">
      <div class="tool-card">
        <div class="card-title">
          <span>ğŸ“¦ ç´ æåº«</span>
          <label class="switch-label">
            <input type="checkbox" id="bg-mode-toggle"> è¨­ç‚ºèƒŒæ™¯
          </label>
        </div>
        <div class="category-tabs">
          <button class="tab-btn active-tab" onclick="switchCategory('stickers', this)">ğŸ¶ è²¼åœ–</button>
          <button class="tab-btn" onclick="switchCategory('backgrounds', this)">ğŸ–¼ï¸ èƒŒæ™¯</button>
          <button class="tab-btn" onclick="switchCategory('stamps', this)">ğŸ’® å°ç« </button>
        </div>
        <div id="sticker-list" class="sticker-grid"><p>è®€å–ä¸­...</p></div>
        <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #eee;">
           <input type="file" accept="image/*" onchange="handleUniversalUpload(this)">
        </div>
      </div>

      <div class="tool-card">
        <div class="card-title">æ¨¡å¼èˆ‡ç­†åˆ·</div>
        <div class="full-width">
          <button onclick="setMode('select')" id="btn-select" class="active">âœ‹ èª¿æ•´</button>
          <button onclick="setMode('draw')" id="btn-draw">ğŸ–Œï¸ å¡—é´‰</button>
        </div>
        <div id="brush-controls" style="margin-top:10px; display:none;">
          é¡è‰²: <input type="color" id="brush-color" value="#4a4a4a">
          <select id="brush-type" onchange="updateBrush()">
            <option value="pencil">é‰›ç­†</option>
            <option value="marker">è¢å…‰ç­†</option>
            <option value="eraser">æ©¡çš®æ“¦</option>
          </select>
          ç²—ç´°: <input type="range" id="brush-width" min="1" max="50" value="5">
        </div>
      </div>
      
      <div class="tool-card">
        <div class="card-title">æ–‡å­—èˆ‡åœ–å±¤</div>
        <input type="text" id="text-input" value="æ–°æ˜¥å¿«æ¨‚" style="width:60%">
        <input type="color" id="text-color" value="#d65a75">
        <button onclick="addText()">ï¼‹æ–‡å­—</button>
        <br><br>
        <div class="btn-group">
          <button onclick="moveLayer('front')">ç½®é ‚</button>
          <button onclick="moveLayer('back')">ç½®åº•</button>
        </div>
      </div>
    </div>
  </div>

  <div id="status-msg">æ“ä½œæˆåŠŸ</div>

  <script>
    // âš ï¸ å¡«å…¥ Key âš ï¸
    const SUPABASE_URL = 'https://xxxxxxxxxxxx.supabase.co'; 
    const SUPABASE_KEY = 'æ‚¨çš„_ANON_KEY';

    // å»¶é²è¼‰å…¥ç¢ºä¿ DOM å­˜åœ¨
    window.onload = function() {
      console.log("Window loaded. åˆå§‹åŒ– Fabric...");

      try {
        // è‡ªå‹•è¨ˆç®—å¯¬åº¦
        const container = document.getElementById('canvas-container');
        const containerWidth = container.clientWidth; // æŠ“å–å®¹å™¨å¯¦éš›å¯¬åº¦
        console.log("å®¹å™¨å¯¬åº¦:", containerWidth);

        const canvas = new fabric.Canvas('c', {
          width: containerWidth || 350, // å¦‚æœæŠ“ä¸åˆ°å°±é è¨­ 350
          height: 500, // æ‰‹æ©Ÿç‰ˆé«˜åº¦ä¸ç”¨å¤ªé«˜
          backgroundColor: '#ffffff',
          isDrawingMode: false,
          preserveObjectStacking: true 
        });

        // éš±è— Loading æ–‡å­—
        document.getElementById('loading-text').style.display = 'none';
        console.log("ç•«å¸ƒå»ºç«‹æˆåŠŸï¼");
        
        // å°‡ canvas ç¶å®šåˆ° window ä»¥ä¾¿å…¨åŸŸå­˜å–
        window.canvas = canvas;

        // å•Ÿå‹•å…¶ä»–åŠŸèƒ½
        initApp();

      } catch (e) {
        console.error("ç•«å¸ƒåˆå§‹åŒ–å¤±æ•—:", e);
        alert("ç•«å¸ƒè¼‰å…¥å¤±æ•—ï¼š" + e.message);
      }
    };

    // --- å°‡æ‰€æœ‰åŠŸèƒ½åŒ…åœ¨ initApp è£¡ ---
    function initApp() {
      // é€™è£¡æ”¾åŸæœ¬çš„é‚è¼¯
      loadCloudImages('stickers');
      // ... (ç‚ºç¯€çœç¯‡å¹…ï¼Œæ ¸å¿ƒé‚è¼¯èˆ‡ V11 ç›¸åŒï¼Œè«‹ä¿ç•™åŸæœ¬çš„ function) ...
      // ç‚ºäº†ç¢ºä¿æ‰‹æ©Ÿç‰ˆèƒ½å‹•ï¼Œä»¥ä¸‹æˆ‘åªåˆ—å‡ºå¹¾å€‹é—œéµå‡½å¼ï¼Œ
      // è«‹æŠŠ V11 çš„é‚£äº› undo, redo, processImage ç­‰ç­‰å…¨éƒ¨è²¼å›ä¾†é€™è£¡é¢ï¼Œ
      // æˆ–æ˜¯ç›´æ¥æ”¾åœ¨ script æ¨™ç±¤çš„å…¨åŸŸä¹Ÿå¯ä»¥ã€‚
      // é‡é»æ˜¯ window.onload çš„å•Ÿå‹•é †åºã€‚
    }

    // --- ä»¥ä¸‹è²¼å› V11 çš„æ‰€æœ‰å‡½å¼ ---
    
    let isVertical = false;
    let history = [];
    let historyRedo = [];
    let isHistoryProcessing = false;

    function saveState() {
       // ... åŒ V11 ...
       if (isHistoryProcessing) return;
       if (history.length > 30) history.shift();
       history.push(JSON.stringify(canvas.toDatalessJSON(['isBackground'])));
       historyRedo = [];
    }

    function undo() {
      if (history.length === 0) return;
      isHistoryProcessing = true;
      historyRedo.push(JSON.stringify(canvas.toDatalessJSON(['isBackground'])));
      const content = history.pop();
      canvas.loadFromJSON(content, () => {
         // ç°¡æ˜“ç‰ˆ restore locks
         canvas.getObjects().forEach(o => {
            if(o.isBackground) { o.set({selectable:false, evented:false}); canvas.sendToBack(o); }
         });
         canvas.renderAll();
         isHistoryProcessing = false;
         showStatus('å·²å¾©åŸ');
      });
    }
    
    function redo() {
      if (historyRedo.length === 0) return;
      isHistoryProcessing = true;
      history.push(JSON.stringify(canvas.toDatalessJSON(['isBackground'])));
      const content = historyRedo.pop();
      canvas.loadFromJSON(content, () => {
         canvas.getObjects().forEach(o => {
            if(o.isBackground) { o.set({selectable:false, evented:false}); canvas.sendToBack(o); }
         });
         canvas.renderAll();
         isHistoryProcessing = false;
         showStatus('å·²é‡åš');
      });
    }

    function setMode(mode) {
      document.getElementById('btn-select').className = (mode === 'select' ? 'active' : '');
      document.getElementById('btn-draw').className = (mode === 'draw' ? 'active' : '');
      document.getElementById('brush-controls').style.display = (mode === 'draw') ? 'block' : 'none';
      canvas.isDrawingMode = (mode === 'draw');
      if(mode==='draw') updateBrush();
    }

    function updateBrush() {
       // ... åŒ V11 ...
       const type = document.getElementById('brush-type').value;
       const color = document.getElementById('brush-color').value;
       const width = parseInt(document.getElementById('brush-width').value, 10);
       
       if (type === 'eraser') {
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        canvas.freeDrawingBrush.color = "#ffffff";
        canvas.freeDrawingBrush.width = width * 3;
       } else {
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        canvas.freeDrawingBrush.color = color;
        canvas.freeDrawingBrush.width = width;
       }
    }

    function addText() {
       const text = new fabric.IText(document.getElementById('text-input').value, {
          left: 50, top: 100, fontSize: 40, fill: document.getElementById('text-color').value,
          fontFamily: 'Noto Sans TC'
       });
       canvas.add(text);
       canvas.setActiveObject(text);
       setMode('select');
    }

    function moveLayer(dir) {
       const active = canvas.getActiveObject();
       if(!active) return;
       if(dir==='front') active.bringToFront();
       if(dir==='back') active.sendToBack();
       saveState();
    }
    
    function clearCanvas() {
       if(confirm('æ¸…ç©ºï¼Ÿ')) { canvas.clear(); canvas.setBackgroundColor('#ffffff'); saveState(); }
    }

    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'card.png';
      link.href = canvas.toDataURL({format:'png', quality:1});
      link.click();
    }
    
    function showStatus(msg) {
      const el = document.getElementById('status-msg');
      el.textContent = msg;
      el.style.opacity = 1;
      setTimeout(() => el.style.opacity = 0, 2000);
    }
    
    // ç¶å®šäº‹ä»¶
    setTimeout(() => {
        if(window.canvas) {
            canvas.on('object:added', (e) => { if(!isHistoryProcessing) saveState(); });
            canvas.on('object:modified', saveState);
            canvas.on('path:created', saveState);
            saveState();
        }
    }, 1000);

    // ç°¡åŒ–çš„åœ–ç‰‡è™•ç† (è«‹æŠŠ switchCategory, loadCloudImages, handleUniversalUpload, processImage å®Œæ•´é‚è¼¯è£œå›ä¾†)
    // ç‚ºäº†é™¤éŒ¯ï¼Œé€™è£¡å…ˆå¯«æœ€ç°¡å–®çš„åˆ†é¡åˆ‡æ›
    window.switchCategory = function(cat, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        btn.classList.add('active-tab');
        document.getElementById('bg-mode-toggle').checked = (cat === 'backgrounds');
        loadCloudImages(cat);
    }

    async function loadCloudImages(folder) {
        const listDiv = document.getElementById('sticker-list');
        listDiv.innerHTML = 'è®€å–...';
        if (SUPABASE_URL.includes('xxxx')) { listDiv.innerHTML = 'è«‹å¡« Key'; return; }
        
        try {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const { data, error } = await supabase.storage.from('assets').list(folder);
            if(error) throw error;
            
            listDiv.innerHTML = '';
            if(data && data.length > 0) {
               data.forEach(item => {
                  if(item.name === '.emptyFolderPlaceholder') return;
                  const url = supabase.storage.from('assets').getPublicUrl(folder + '/' + item.name).data.publicUrl;
                  const img = document.createElement('img');
                  img.src = url;
                  img.onclick = () => {
                      fabric.Image.fromURL(url, (oImg) => {
                          // ç°¡æ˜“ processImage
                          const isBg = document.getElementById('bg-mode-toggle').checked;
                          if(isBg) {
                             const s = Math.max(canvas.width/oImg.width, canvas.height/oImg.height);
                             oImg.set({scaleX:s, scaleY:s, left:canvas.width/2, top:canvas.height/2, originX:'center', originY:'center', selectable:false, evented:false, isBackground:true});
                             canvas.add(oImg); canvas.sendToBack(oImg);
                          } else {
                             oImg.scaleToWidth(100);
                             oImg.set({left:100, top:100});
                             canvas.add(oImg); canvas.setActiveObject(oImg);
                          }
                          setMode('select');
                      }, {crossOrigin:'anonymous'});
                  };
                  listDiv.appendChild(img);
               });
            } else { listDiv.innerHTML = 'ç„¡åœ–ç‰‡'; }
        } catch(e) { 
           console.error(e); 
           listDiv.innerHTML = 'éŒ¯èª¤';
        }
    }
    
    function handleUniversalUpload(input) {
       // ... åŒ V11 ...
       if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                fabric.Image.fromURL(e.target.result, function (img) {
                    img.scaleToWidth(150);
                    canvas.add(img);
                    canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(input.files[0]);
       }
    }

  </script>
</body>
</html>
